/*! couchapp-todo 2014-01-05 */
function AppCtrl(a,b){a.pendingTicklers=b.pendingTicklers,b.update()}function OverviewCtrl(a,b,c,d){d.update()}function NextCtrl(a,b,c,d){a.subtype="next",TodoCtrl(a,b,c,d)}function FutureCtrl(a,b,c,d){a.subtype="future",TodoCtrl(a,b,c,d)}function WaitingCtrl(a,b,c,d){a.subtype="waiting",TodoCtrl(a,b,c,d)}function TodoCtrl(a,b,c,d){d.update(),a.server=c();var e=parseUri(b.absUrl());a.userdb=a.server.getDB(e.database),remoteDatabase=e.protocol+"//"+e.host+"/"+e.database+"/";a.userdb.pouchdb.replicate.from(remoteDatabase,{continuous:!0}),a.userdb.pouchdb.replicate.to(remoteDatabase,{continuous:!0});a.tags={list:[]},a.updateTagsList=function(){a.userdb.query("todo","tags",{group:!0}).then(function(b){for(var c=["[All Tags]"],d=0;d<b.rows.length;d++){var e=b.rows[d];c.push(e.key)}a.tags.list=c,"undefined"==typeof a.tags.selected&&a.changedTag(a.tags.list[0])})},a.initNewTodo=function(){a.newTodo=a.userdb.newDoc(),a.newTodo.type="todo",a.newTodo.tags=[]},a.initNewTodo(),a.updateTagsList(),a.addTodo=function(){a.newTodo.subtype=a.subtype,a.newTodo.tags.push(a.tags.selected),a.newTodo.save().then(function(){a.changedTag(),a.updateTagsList()}),a.initNewTodo()},a.changedTag=function(b){"undefined"!=typeof b&&(a.tags.selected=b);var c=[a.tags.selected],d=[a.tags.selected,{}];a.todos_bytags={},"[All Tags]"===a.tags.selected&&(c=void 0,d=void 0),a.userdb.query("todo",a.subtype+"_by_tag",{startkey:c,endkey:d,include_docs:!0}).then(function(b){for(var c=0;c<b.rows.length;c++){var d=b.rows[c],e=d.key[0];a.todos_bytags.hasOwnProperty(e)||(a.todos_bytags[e]={tag:e,list:[]});var f=a.userdb.newDoc(d.doc);"undefined"==typeof f.subtype&&(f.subtype="next"),a.todos_bytags[e].list.push(f)}})},a.countRemaining=function(){var b=0;return angular.forEach(a.todos_bytags,function(a){angular.forEach(a.list,function(a){b+=a.done?0:1})}),b},a.countAll=function(){var b=0;return angular.forEach(a.todos_bytags,function(a){b+=a.list.length}),b},a.archive=function(){a.todos_bytags.hasOwnProperty(a.tags.selected)&&angular.forEach(a.todos_bytags[a.tags.selected].list,function(a){a.done&&a.remove()})}}function TicklerCtrl(a,b,c,d){d.update(),a.subtype="tickler",a.server=c();var e=parseUri(b.absUrl());a.userdb=a.server.getDB(e.database),a.initNewTodo=function(){a.newTodo=a.userdb.newDoc(),a.newTodo.type="todo",a.newTodo.tags=[]},a.initNewTodo(),a.addTodo=function(){a.newTodo.subtype=a.subtype,a.newTodo.save().then(function(){a.getTicklers()}),a.initNewTodo()},a.getTicklers=function(){function b(b,c,d){a.userdb.query("todo","tickler_by_date",{startkey:b,endkey:c,include_docs:!0}).then(function(b){d.list=[];for(var c=0;c<b.rows.length;c++){var e=b.rows[c],f=a.userdb.newDoc(e.doc);d.list.push(f)}})}date=getIsoDate((new Date).addDays(1)),date7=getIsoDate((new Date).addDays(8)),a.todos_grouped=[{title:"Pending",list:[]},{title:"Next 7 Days",list:[]},{title:"Future",list:[]}],b(void 0,[date],a.todos_grouped[0]),b([date],[date7],a.todos_grouped[1]),b([date7],void 0,a.todos_grouped[2])},a.getTicklers(),a.countRemaining=function(){var b=0;return angular.forEach(a.todos_grouped,function(a){angular.forEach(a.list,function(a){b+=a.done?0:1})}),b},a.countAll=function(){var b=0;return angular.forEach(a.todos_grouped,function(a){b+=a.list.length}),b},a.archive=function(){angular.forEach(a.todos_grouped,function(a){angular.forEach(a.list,function(a){a.done&&a.remove()})})}}function parseUri(a){var b=document.createElement("a");b.href=a;var c={};c.protocol=b.protocol,c.hostname=b.hostname,c.port=b.port,c.pathname=b.pathname,c.search=b.search,c.hash=b.hash,c.host=b.host;var d=new RegExp("/([^/]+)/_design/.*"),e=d.exec(c.pathname);return c.database=e[1],c}function getIsoDate(a){"undefined"==typeof a&&(a=new Date);var b=a.getFullYear(),c=a.getMonth()+1;9>=c&&(c="0"+c);var d=a.getDate();9>=d&&(d="0"+d);var e=b+"-"+c+"-"+d;return e}var App=angular.module("TodoApp",["CornerCouch"]).config(function(a){a.when("/",{controller:OverviewCtrl,templateUrl:"overview.html"}).when("/next",{controller:NextCtrl,templateUrl:"next.html"}).when("/future",{controller:FutureCtrl,templateUrl:"next.html"}).when("/waiting",{controller:WaitingCtrl,templateUrl:"next.html"}).when("/tickler",{controller:TicklerCtrl,templateUrl:"tickler.html"}).otherwise({redirectTo:"/"})}).service("TicklerWatch",["$rootScope","$timeout","$location","cornercouch",function(a,b,c,d){function e(){var a=new Date;if(a-h>6e4){h=a;var b=getIsoDate(h);userdb.query("todo","tickler_by_date",{startkey:void 0,endkey:[b,{}],include_docs:!1}).then(function(a){f=a.rows.length>0})}}var f=!1,g=d(),h=new Date(0),i=parseUri(c.absUrl());return userdb=g.getDB(i.database),{pendingTicklers:function(){return f},update:e}}]);App.directive("mytodo",function(){return{restrict:"E",template:'<div ng-hide="editing"><input style="float:right" type="checkbox" ng-model="todo.done" ng-change="saveTodo()"> <a class="todo_title done-{{todo.done}}" href="" ng-click="toggleDetails()"><span class="todo_date" ng_show="isTickler()">{{todo.date}} </span>{{todo.title}}<span ng_show="detailsavailable() && !showDetails"> &hellip;</span></a> <a href="" ng_show="showDetails" ng-click="editTodo()">&#9998;</a><div ng_show="showDetails" markup="todo.details"></div><span ng_show="showDetails" class="tag" ng-repeat="tag in todo.tags">{{tag}}</span></div><div ng_show="editing"><input class="todo_title" type="text" ng-model="todo.title"> <a href="" ng-click="saveTodo()">&#10003;</a> <a href="" ng-click="loadTodo()">&#10007;</a><br><label>Type: </label><select ng-model="todo.subtype" ng-options="subtype for subtype in subtypes" ></select><br><span ng_show="isTickler()"><input type="text" ng-model="todo.date"><select ng-model="todo.recurrence" ng-options="option for option in recurrencies" ></select><br></span><textarea class="details_input" ng-model="todo.details.content" placeholder="Details"></textarea><br><select ng-model="todo.details.language"><option value="unformatted">Unformated</option><option value="markdown">Markdown</option><option value="textile">Textile</option></select><br><span class="tag" ng-repeat="tag in todo.tags">{{tag}}&nbsp;<a href="" ng-click="removeTag(tag)">&times;</a> </span><form style="display: inline;" ng-submit="addTag()"><input class="tag" type="text" style="width: 10em;" ng-model="tagText" placeholder="add new tag"></form></div>',scope:{todo:"="},link:function(a){a.subtypes=["next","future","waiting","tickler"],a.recurrencies=["daily","weekly","monthly","yearly"],a.toggleDetails=function(){a.showDetails=!a.showDetails},a.editTodo=function(){a.editing=!0},a.saveTodo=function(){a.todo.save().then(function(){a.editing=!1})},a.loadTodo=function(){a.todo.load().then(function(){a.editing=!1})},a.isTickler=function(){return"tickler"===a.todo.subtype},a.detailsavailable=function(){return"undefined"==typeof a.todo.details?!1:"undefined"==typeof a.todo.details.content?!1:""===a.todo.details.content?!1:!0},a.addTag=function(){a.todo.tags.push(a.tagText),a.tagText=""},a.removeTag=function(b){var c=a.todo.tags.indexOf(b);a.todo.tags.splice(c,1)}}}}),App.directive("markup",function(){return{restrict:"A",scope:!0,link:function(a,b,c){var d=new Showdown.converter;a.$watch(c.markup,function(a){"undefined"!=typeof a&&(a.hasOwnProperty("language")?"markdown"==a.language?b.html(d.makeHtml(a.content)):"textile"==a.language?b.html(convert_textile(a.content)):b.html(a.content):b.html(a))},!0)}}}),Date.prototype.addDays=function(a){return this.setDate(this.getDate()+a),this};